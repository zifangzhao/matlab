%script for extracting all laser trigger

%%
threshold=1.5e4;
laser_thre=20; %laser length threshold in millisecond
fs=20e3;

%%
[f,p]=uigetfile('*.dat','Select original Data file, laser trigger Nch=33');
[ftxt,ptxt]=uigetfile('*.txt','Select laser time generated by Stimu timer');

%%
data=readmulti_frank([p f],33,33,0,inf);

%%
txt=importdata([ptxt ftxt]);
all_txt=txt.textdata(2:end-1);

true_idx=find(cellfun(@(x) ~isempty(strfind(x,'True')),all_txt));
false_idx=find(cellfun(@(x) ~isempty(strfind(x,'False')),all_txt));
true_time=cellfun(@stimu_timer_StringConverter,all_txt(true_idx+1));
false_time=cellfun(@stimu_timer_StringConverter,all_txt(false_idx+1));
win=[-10 0]; %window to search for trigger to behavior
%%
bhv_TF=zeros(size(data));
for idx=length(true_time):-1:1
    index_mask=(true_time(idx)+win(1))*fs:(true_time(idx)+win(2))*fs;
    index_mask(index_mask<=0)=[];
    index_mask(index_mask>length(data))=[];
    bhv_TF(index_mask)=1;
end
for idx=length(false_time):-1:1
    index_mask=(true_time(idx)+win(1))*fs:(true_time(idx)+win(2))*fs;
    index_mask(index_mask<=0)=[];
    index_mask(index_mask>length(data))=[];
    bhv_TF(index_mask)=1;
end    
locs=data>threshold;
locs_diff=diff([0 ;locs]);
locs_starts=find(locs_diff==1);
locs_ends=find(locs_diff==-1);
locs_length=locs_ends-locs_starts;
locs_true=

len_thre=laser_thre*fs/1000;
idx_high=find(locs_length>len_thre);
idx_low=find(locs_length<len_thre);

locs_high=zeros(length(idx_high),1);
events.description=cell(length(locs_high)*2,1);
for idx=1:length(locs_high)
    locs_high(2*idx-1)=locs_starts(idx_high(idx));
    events.description{2*idx-1}='Start';
    locs_high(2*idx)=locs_ends(idx_high(idx));
    events.description{2*idx}='End';
end
events.time=locs_high/fs;
if ispc
    system(['del ' p f(1:end-4) '.hls.evt']);
else
    system(['rm ''' p f(1:end-4) '.hls.evt''']);
end
SaveEvents([p f(1:end-4) '.hls.evt'],events);

locs_low=zeros(length(idx_low),1);
events.description=cell(length(locs_low)*2,1);
for idx=1:length(locs_low)
    locs_low(2*idx-1)=locs_starts(idx_low(idx));
    events.description{2*idx-1}='Start';
    locs_low(2*idx)=locs_ends(idx_low(idx));
    events.description{2*idx}='End';
end
events.time=locs_low/fs;
if ispc
    system(['del ' p f(1:end-4) '.lls.evt']);
else
    system(['rm ''' p f(1:end-4) '.lls.evt''']);
end
SaveEvents([p f(1:end-4) '.lls.evt'],events);